name: CI

on:
  push:
    branches: [ master ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-22.04

    strategy:
      fail-fast: false
      matrix:
        preset: [asan, tsan, release]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools (clang-19, libc++, ninja, cmake, ccache)
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg lsb-release software-properties-common ninja-build cmake ccache

          # LLVM apt for clang/clang-tidy/lld/libc++
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 19
          sudo apt-get install -y \
            clang-19 clang-tidy-19 lldb-19 lld-19 \
            libc++-19-dev libc++abi-19-dev

      - name: Show versions
        run: |
          clang-19 --version
          clang-tidy-19 --version
          cmake --version
          ninja --version
          ccache --version

      # Ensure CI uses clang-19 unless preset overrides it explicitly.
      - name: Configure (${{ matrix.preset }})
        env:
          CC: clang-19
          CXX: clang++-19
        run: cmake --preset ${{ matrix.preset }}

      - name: Build (${{ matrix.preset }})
        run: cmake --build --preset ${{ matrix.preset }} -j

      - name: Test (${{ matrix.preset }})
        run: ctest --preset ${{ matrix.preset }} --output-on-failure

      # - name: Format check
      #   run: cmake --build --preset ${{ matrix.preset }} --target format-check
